generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String             @id @default(cuid())
  email           String             @unique
  emailVerified   DateTime?
  passwordHash    String
  firstName       String
  lastName        String
  phone           String?
  status          UserStatus         @default(ACTIVE)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  profile         StudentProfile?
  staffProfile    StaffProfile?
  roles           UserRole[]
  accounts        Account[]
  sessions        Session[]
  passwordResets  PasswordResetToken[]

  enrollments     Enrollment[]       @relation("StudentEnrollments")
  sectionsTaught  Section[]          @relation("SectionTeacher")
  invoices        Invoice[]
  payments        Payment[]          @relation("PaymentRecorder")
  auditLogs       AuditLog[]         @relation("AuditActor")
  notifications   Notification[]
  ticketsRaised   SupportTicket[]    @relation("TicketRequester")
  ticketsOwned    SupportTicket[]    @relation("TicketAssignee")
  workflowRequests WorkflowApproval[] @relation("WorkflowRequester")
  workflowApprovals WorkflowApproval[] @relation("WorkflowApprover")
  departmentsHeaded Department[]     @relation("DepartmentHead")
  attendanceRecords AttendanceRecord[] @relation("AttendanceTeacher")
  gradesSubmitted  Grade[]           @relation("GradeSubmitter")
  gradesApproved   Grade[]           @relation("GradeApprover")
}

model Role {
  id          String          @id @default(cuid())
  name        RoleName        @unique
  description String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  users       UserRole[]
  permissions RolePermission[]
}

model Permission {
  id        String            @id @default(cuid())
  code      String            @unique
  label     String
  createdAt DateTime          @default(now())

  roles     RolePermission[]
}

model UserRole {
  id         String   @id @default(cuid())
  userId     String
  roleId     String
  assignedBy String?
  assignedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
}

model RolePermission {
  id           String @id @default(cuid())
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model Department {
  id          String     @id @default(cuid())
  code        String     @unique
  name        String
  description String?
  headId      String?

  head        User?      @relation("DepartmentHead", fields: [headId], references: [id])
  programs    Program[]
  staff       StaffProfile[]
  courses     Course[]
}

model Program {
  id           String       @id @default(cuid())
  departmentId String
  code         String
  name         String
  level        ProgramLevel
  description  String?

  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  courses      Course[]
  students     StudentProfile[] @relation("ProgramStudents")

  @@unique([departmentId, code])
}

model Term {
  id         String    @id @default(cuid())
  year       Int
  semester   Semester
  startDate  DateTime
  endDate    DateTime
  isCurrent  Boolean   @default(false)

  sections   Section[]
  invoices   Invoice[]
  calendar   AcademicCalendar?

  @@unique([year, semester])
}

model AcademicCalendar {
  id        String   @id @default(cuid())
  termId    String   @unique
  events    Json
  published Boolean  @default(false)

  term Term @relation(fields: [termId], references: [id], onDelete: Cascade)
}

model Course {
  id            String        @id @default(cuid())
  programId     String
  departmentId  String
  code          String
  title         String
  credits       Int
  description   String?
  syllabusUrl   String?
  feeAmount     Decimal       @default(0) @db.Decimal(10, 2)

  department Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  program    Program    @relation(fields: [programId], references: [id], onDelete: Cascade)
  sections   Section[]

  @@unique([departmentId, code])
}

model Section {
  id           String    @id @default(cuid())
  courseId     String
  termId       String
  teacherId    String?
  sectionCode  String
  schedule     Json
  capacity     Int?

  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  term    Term   @relation(fields: [termId], references: [id], onDelete: Cascade)
  teacher User?  @relation("SectionTeacher", fields: [teacherId], references: [id])
  enrollments Enrollment[]
  attendance  AttendanceRecord[]

  @@unique([courseId, termId, sectionCode])
}

model Enrollment {
  id          String           @id @default(cuid())
  studentId   String
  sectionId   String
  status      EnrollmentStatus @default(PENDING)
  enrolledAt  DateTime         @default(now())
  approvedBy  String?
  approvalAt  DateTime?

  student User   @relation("StudentEnrollments", fields: [studentId], references: [id], onDelete: Cascade)
  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  grade   Grade?

  @@unique([studentId, sectionId])
}

model AttendanceRecord {
  id          String   @id @default(cuid())
  sectionId   String
  recordedBy  String
  recordedAt  DateTime @default(now())
  meetingDate DateTime
  notes       String?
  entries     Json

  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  teacher User    @relation("AttendanceTeacher", fields: [recordedBy], references: [id], onDelete: Cascade)
}

model Grade {
  id            String      @id @default(cuid())
  enrollmentId  String      @unique
  submittedBy   String?
  approvedBy    String?
  status        GradeStatus @default(DRAFT)
  score         Float?
  letter        String?
  metadata      Json?
  submittedAt   DateTime?
  approvedAt    DateTime?

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  submitter  User?       @relation("GradeSubmitter", fields: [submittedBy], references: [id])
  approver   User?       @relation("GradeApprover", fields: [approvedBy], references: [id])
}

model Invoice {
  id          String        @id @default(cuid())
  studentId   String
  termId      String
  number      String        @unique
  dueDate     DateTime
  amountDue   Decimal       @db.Decimal(12, 2)
  amountPaid  Decimal       @default(0) @db.Decimal(12, 2)
  status      InvoiceStatus @default(PENDING)
  issuedBy    String?
  issuedAt    DateTime      @default(now())

  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)
  term    Term @relation(fields: [termId], references: [id], onDelete: Cascade)
  payments Payment[]
}

model Payment {
  id              String        @id @default(cuid())
  invoiceId       String
  amount          Decimal       @db.Decimal(12, 2)
  status          PaymentStatus @default(PENDING)
  method          String
  chapaReference  String?
  processorResponse Json?
  paidAt          DateTime?
  recordedBy      String?

  invoice  Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  recorder User?   @relation("PaymentRecorder", fields: [recordedBy], references: [id])
}

model WorkflowApproval {
  id          String          @id @default(cuid())
  entityType  WorkflowEntity
  entityId    String
  action      String
  status      ApprovalStatus @default(PENDING)
  requestedBy String
  approverId  String?
  requestedAt DateTime        @default(now())
  decidedAt   DateTime?
  notes       String?

  approver  User? @relation("WorkflowApprover", fields: [approverId], references: [id])
  requester User  @relation("WorkflowRequester", fields: [requestedBy], references: [id], onDelete: Cascade)
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  body      String
  metadata  Json?
  readAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SupportTicket {
  id           String        @id @default(cuid())
  requesterId  String
  assigneeId   String?
  category     TicketCategory
  status       TicketStatus   @default(OPEN)
  priority     TicketPriority @default(MEDIUM)
  subject      String
  description  String
  resolution   String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  requester User @relation("TicketRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  assignee  User? @relation("TicketAssignee", fields: [assigneeId], references: [id])
}

model StaffProfile {
  id             String      @id @default(cuid())
  userId         String      @unique
  departmentId   String?
  position       String
  employmentType EmploymentType
  hireDate       DateTime
  bio            String?

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department? @relation(fields: [departmentId], references: [id])
}

model StudentProfile {
  id            String        @id @default(cuid())
  userId        String        @unique
  programId     String?
  admissionType AdmissionType?
  yearLevel     Int?
  semester      Int?
  guardianName  String?
  guardianPhone String?

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  program Program? @relation("ProgramStudents", fields: [programId], references: [id])
}

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String?
  action     String
  entityType String
  entityId   String?
  ipAddress  String?
  userAgent  String?
  payload    Json?
  createdAt  DateTime @default(now())

  actor User? @relation("AuditActor", fields: [actorId], references: [id])
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String? @db.Text
  access_token             String? @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String? @db.Text
  session_state            String?
  refresh_token_expires_in Int?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum UserStatus {
  ACTIVE
  INVITED
  SUSPENDED
  ARCHIVED
}

enum RoleName {
  ADMINISTRATOR
  TEACHER
  DEPARTMENT_HEAD
  FINANCE_OFFICER
  STUDENT
  REGISTRAR
  LIBRARIAN
  IT_SUPPORT
  HR
}

enum ProgramLevel {
  UNDERGRADUATE
  GRADUATE
  CERTIFICATE
}

enum Semester {
  FALL
  SPRING
  SUMMER
}

enum EnrollmentStatus {
  PENDING
  APPROVED
  REJECTED
  DROPPED
}

enum GradeStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

enum InvoiceStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum WorkflowEntity {
  ENROLLMENT
  GRADE
  COURSE
  PAYMENT
  OTHER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  ESCALATED
}

enum TicketCategory {
  TECHNICAL
  ACCESS
  HARDWARE
  OTHER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
}

enum AdmissionType {
  REGULAR
  EXTENSION
  DISTANCE
  SPECIAL
}
